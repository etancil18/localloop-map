<!DOCTYPE html>
<html>
<head>
  <title>LocalLoop MVP Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    body { margin: 0; padding: 0; }
    #map { height: 100vh; width: 100vw; }
    #details {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      background: white;
      padding: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-family: sans-serif;
      font-size: 14px;
      display: none;
      z-index: 1000;
    }
    #details button {
      display: block;
      margin-top: 5px;
      background: #ccc;
      border: none;
      padding: 5px;
      cursor: pointer;
    }
    #vibeFilter, #map-search, #clearRoute {
      position: absolute;
      z-index: 1000;
      font-size: 14px;
      padding: 5px;
    }
    #map-search { top: 10px; left: 50px; width: 250px; }
    #vibeFilter { top: 10px; left: 330px; }
    #clearRoute { top: 10px; right: 350px; }
  </style>
</head>
<body>

<input id="map-search" type="text" placeholder="Search by name or vibe..." />
<select id="vibeFilter">
  <option value="">Show All</option>
  <option value="jazz">Jazz</option>
  <option value="artsy">Artsy</option>
  <option value="cozy">Cozy</option>
  <option value="hip">Hip</option>
  <option value="trendy">Trendy</option>
  <option value="rustic">Rustic</option>
  <option value="hidden gem">Hidden Gem</option>
  <option value="wine">Wine</option>
</select>
<button id="clearRoute">Clear Route</button>

<div id="map"></div>
<div id="details"><strong>Click a pin to see details</strong></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
const map = L.map('map').setView([40.72, -73.98], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const markerCluster = L.markerClusterGroup({
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: false,
  zoomToBoundsOnClick: true,
  maxClusterRadius: 40,
  disableClusteringAtZoom: 17
});
map.addLayer(markerCluster);

const allMarkers = [];
let selectedPoints = [];
let currentRoute = null;

fetch('events.json')
  .then(res => res.json())
  .then(events => {
    events.forEach(ev => {
      const marker = L.marker([ev.lat, ev.lon], {
        icon: L.divIcon({
          className: '',
          html: 'üìç',
          iconSize: [10, 10],
          iconAnchor: [5, 5]
        })
      });

      marker.vibe = ev.vibe.toLowerCase();
      marker.name = ev.name.toLowerCase();
      marker.bindPopup(`<b>${ev.name}</b>`);

      marker.on('click', () => {
        const details = document.getElementById('details');
        details.innerHTML = `
          <strong>${ev.name}</strong><br>
          Vibe: ${ev.vibe}<br>
          <a href="${ev.link}" target="_blank">View More</a><br>
          <button id="closeDetails">Close</button>
        `;
        details.style.display = 'block';

        document.getElementById('closeDetails').addEventListener('click', () => {
          details.style.display = 'none';
        });

        handleRouteSelection(marker.getLatLng());
      });

      allMarkers.push(marker);
      markerCluster.addLayer(marker);
    });
  })
  .catch(err => console.error('Error loading events.json:', err));

function applyFilters() {
  const vibe = document.getElementById('vibeFilter').value.toLowerCase();
  const query = document.getElementById('map-search').value.toLowerCase();

  markerCluster.clearLayers();

  allMarkers.forEach(marker => {
    const vibeMatch = !vibe || marker.vibe.includes(vibe);
    const searchMatch = !query || marker.name.includes(query) || marker.vibe.includes(query);

    if (vibeMatch && searchMatch) {
      markerCluster.addLayer(marker);
    }
  });
}

function handleRouteSelection(latlng) {
  selectedPoints.push(latlng);
  if (selectedPoints.length === 2) {
    if (currentRoute) map.removeControl(currentRoute);
    currentRoute = L.Routing.control({
      waypoints: selectedPoints,
      routeWhileDragging: true
    }).addTo(map);
    selectedPoints = [];
  }
}

document.getElementById('vibeFilter').addEventListener('change', applyFilters);
document.getElementById('map-search').addEventListener('input', applyFilters);
document.getElementById('clearRoute').addEventListener('click', () => {
  if (currentRoute) {
    map.removeControl(currentRoute);
    currentRoute = null;
  }
  selectedPoints = [];
});
</script>
</body>
</html>
